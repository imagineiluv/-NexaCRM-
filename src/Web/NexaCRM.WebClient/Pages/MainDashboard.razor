@page "/main-dashboard"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<MainDashboard> Localizer
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Sales,Manager")]

<div class="relative flex size-full min-h-screen flex-col bg-slate-50 group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;' data-page="main-dashboard">
    <!-- Mobile Header Bar -->
    <div class="mobile-header" style="display: flex !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; z-index: 999999 !important; background-color: #ffffff !important; border-bottom: 1px solid #e5e7eb !important; height: 60px !important; width: 100vw !important; box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;">
        <div class="mobile-header-content" style="display: flex !important; align-items: center !important; justify-content: space-between !important; width: 100% !important; padding: 0 1rem !important;">
            <button class="mobile-menu-toggle" @onclick="ToggleMobileMenu" title="@Localizer["OpenMenu"]" style="display: flex !important; align-items: center !important; justify-content: center !important; padding: 0.5rem !important; background: none !important; border: none !important; color: #374151 !important;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path>
                </svg>
            </button>
            
            <div class="mobile-header-title" style="display: flex !important; flex: 1 !important; justify-content: center !important;">
                <h1 class="mobile-title" style="display: block !important; font-size: 1.25rem !important; font-weight: 700 !important; color: #374151 !important; margin: 0 !important;">@Localizer["CRM"]</h1>
            </div>
            
            <div class="mobile-header-actions" style="display: flex !important; gap: 0.5rem !important; align-items: center !important;">
                <button class="mobile-action-btn" @onclick="ToggleMobileSearch" title="@Localizer["Search"]" style="display: flex !important; align-items: center !important; justify-content: center !important; padding: 0.5rem !important; background: none !important; border: none !important; color: #374151 !important;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                    </svg>
                </button>
                <button class="mobile-action-btn mobile-notifications-btn" @onclick="ToggleMobileNotifications" title="@Localizer["Notifications"]" style="display: flex !important; align-items: center !important; justify-content: center !important; padding: 0.5rem !important; background: none !important; border: none !important; color: #374151 !important; position: relative !important;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"></path>
                    </svg>
                    <span class="notification-badge" style="display: block !important; position: absolute !important; top: -2px !important; right: -2px !important; background-color: #ef4444 !important; color: white !important; font-size: 0.75rem !important; padding: 0.125rem 0.375rem !important; border-radius: 0.5rem !important; min-width: 1rem !important; text-align: center !important;">3</span>
                </button>
            </div>
        </div>
        
        <!-- Mobile Search Bar (collapsed by default) -->
        <div class="mobile-search-bar @(showMobileSearch ? "expanded" : "collapsed")">
            <div class="mobile-search-input">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                </svg>
                <input type="text" placeholder='@Localizer["Search"]' @bind="mobileSearchQuery" @onkeyup="HandleMobileSearch" />
                <button class="mobile-search-close" @onclick="ToggleMobileSearch">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Quick Actions Bar -->
    <div class="mobile-quick-actions">
        <AuthorizeView>
            <Authorized>
                @{
                    var salesLink = "/sales-pipeline-page";
                    if (context.User.IsInRole("Manager"))
                    {
                        salesLink = "/sales-manager-dashboard";
                    }
                }
                <button class="quick-action-btn" @onclick="@(() => NavigateToPage(salesLink))" title="@Localizer["Sales"]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M152,120H136V56h8a32,32,0,0,1,32,32,8,8,0,0,0,16,0,48.05,48.05,0,0,0-48-48h-8V24a8,8,0,0,0-16,0V40h-8a48,48,0,0,0,0,96h8v64H104a32,32,0,0,1-32-32,8,8,0,0,0-16,0,48.05,48.05,0,0,0,48,48h16v16a8,8,0,0,0,16,0V216h16a48,48,0,0,0,0-96Zm-40,0a32,32,0,0,1,0-64h8v64Zm40,80H136V136h16a32,32,0,0,1,0,64Z"></path>
                    </svg>
                    <span>@Localizer["Sales"]</span>
                </button>
                
                <button class="quick-action-btn" @onclick="@(() => NavigateToPage("/contacts"))" title="@Localizer["Contacts"]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M117.25,157.92a60,60,0,1,0-66.5,0A95.83,95.83,0,0,0,3.53,195.63a8,8,0,1,0,13.4,8.74,80,80,0,0,1,134.14,0,8,8,0,0,0,13.4-8.74A95.83,95.83,0,0,0,117.25,157.92ZM40,108a44,44,0,1,1,44,44A44.05,44.05,0,0,1,40,108Z"></path>
                    </svg>
                    <span>@Localizer["Contacts"]</span>
                </button>
                
                <button class="quick-action-btn" @onclick="@(() => NavigateToPage("/tasks-page"))" title="@Localizer["Tasks"]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M80,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H88A8,8,0,0,1,80,64Zm136,56H88a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Zm0,64H88a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path>
                    </svg>
                    <span>@Localizer["Tasks"]</span>
                </button>
                
                <button class="quick-action-btn" @onclick="@(() => NavigateToPage("/reports-page"))" title="@Localizer["Reports"]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M216,40H136V24a8,8,0,0,0-16,0V40H40A16,16,0,0,0,24,56V176a16,16,0,0,0,16,16H79.36L57.75,219a8,8,0,0,0,12.5,10l29.59-37h56.32l29.59,37a8,8,0,1,0,12.5-10l-21.61-27H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Z"></path>
                    </svg>
                    <span>@Localizer["Reports"]</span>
                </button>
            </Authorized>
        </AuthorizeView>
    </div>

    <!-- Mobile Notifications Panel (collapsed by default) -->
    <div class="mobile-notifications-panel @(showMobileNotifications ? "expanded" : "collapsed")">
        <div class="mobile-notifications-header">
            <h3>@Localizer["Notifications"]</h3>
            <button class="mobile-notifications-close" @onclick="ToggleMobileNotifications">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
                </svg>
            </button>
        </div>
        <div class="mobile-notifications-content">
            <div class="notification-item">
                <div class="notification-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M256,136a8,8,0,0,1-8,8H232v16a8,8,0,0,1-16,0V144H200a8,8,0,0,1,0-16h16V112a8,8,0,0,1,16,0v16h16A8,8,0,0,1,256,136Z"></path>
                    </svg>
                </div>
                <div class="notification-content">
                    <div class="notification-title">@Localizer["NewLead"]</div>
                    <div class="notification-time">2 @Localizer["MinutesAgo"]</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34Z"></path>
                    </svg>
                </div>
                <div class="notification-content">
                    <div class="notification-title">@Localizer["DealClosed"]</div>
                    <div class="notification-time">15 @Localizer["MinutesAgo"]</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z"></path>
                    </svg>
                </div>
                <div class="notification-content">
                    <div class="notification-title">@Localizer["TaskReminder"]</div>
                    <div class="notification-time">1 @Localizer["HourAgo"]</div>
                </div>
            </div>
        </div>
    </div>

    <div class="layout-container flex h-full grow">
        <!-- Icon Bar -->
        <div class="flex-shrink-0 bg-gray-800 text-white flex flex-col items-center justify-between p-2" style="width: 60px;">
            <div class="flex flex-col items-center">
                <!-- Brand Icon -->
                <div class="p-2 mb-4">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                </div>
                <!-- Navigation Icons -->
                <nav class="flex flex-col space-y-4">
                    <a href="#" class="p-2 rounded-lg bg-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    </a>
                    <a href="#" class="p-2 rounded-lg hover:bg-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                    </a>
                    <a href="#" class="p-2 rounded-lg hover:bg-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 3c-1.1 0-2 .9-2 2v2.68C8.04 8.1 6.1 10.04 5.68 12H3c-1.1 0-2 .9-2 2s.9 2 2 2h2.68c.42 1.96 2.36 3.9 4.32 4.32V20c0 1.1.9 2 2 2s2-.9 2-2v-2.68c1.96-.42 3.9-2.36 4.32-4.32H21c1.1 0 2-.9 2-2s-.9-2-2-2h-2.68C17.9 10.04 15.96 8.1 14 7.68V5c0-1.1-.9-2-2-2zm0 4c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4z"/></svg>
                    </a>
                    <a href="#" class="p-2 rounded-lg hover:bg-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18 8c0-3.31-2.69-6-6-6S6 4.69 6 8c0 4.5 6 11 6 11s6-6.5 6-11zm-8 0c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/></svg>
                    </a>
                    <a href="#" class="p-2 rounded-lg hover:bg-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10z"/></svg>
                    </a>
                </nav>
            </div>
            <!-- Settings Icon -->
            <div class="p-2">
                <a href="/settings-page" class="p-2 rounded-lg hover:bg-gray-700">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                </a>
            </div>
        </div>

        <!-- Navigation Panel -->
        <div class="flex-shrink-0 bg-white border-r border-gray-200 flex flex-col" style="width: 280px;">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center">
                    <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User" />
                    <div class="ml-3">
                        <p class="text-sm font-semibold text-gray-800">John Doe</p>
                        <p class="text-xs text-gray-500">customerpop@gmail.com</p>
                    </div>
                </div>
            </div>
            <div class="flex-1 p-4 space-y-4">
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase">Projects</h3>
                    <a href="#" class="flex items-center justify-between p-2 rounded-lg bg-gray-100 text-sm font-medium text-gray-800">
                        <span>Dashboard</span>
                        <span class="px-2 py-0.5 rounded-full bg-gray-200 text-xs">0</span>
                    </a>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        Library
                    </a>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        Shared Projects
                    </a>
                </div>
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase">Status</h3>
                    <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        <span>New</span>
                        <span class="px-2 py-0.5 rounded-full bg-gray-200 text-xs">3</span>
                    </a>
                    <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        <span>Updates</span>
                        <span class="px-2 py-0.5 rounded-full bg-gray-200 text-xs">2</span>
                    </a>
                     <a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        Team Review
                    </a>
                </div>
                 <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase">History</h3>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        Recently Edited
                    </a>
                    <a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-sm font-medium text-gray-600">
                        Archive
                    </a>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col bg-gray-50">
            <div class="p-8">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <p class="text-gray-500">All Your Workflows And Permissions Managed</p>

                <div class="mt-8 p-8 bg-white rounded-lg shadow-md text-center">
                    <p class="text-gray-500">Executions</p>
                    <p class="text-6xl font-bold text-gray-800 mt-2">340</p>
                    <p class="text-green-500 mt-2">↑ 204%</p>
                    <a href="#" class="inline-block mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">
                        See Report →
                    </a>
                </div>

                <div class="mt-8">
                    <div class="flex border-b">
                        <button class="py-2 px-4 text-sm font-medium text-indigo-600 border-b-2 border-indigo-500">Workflows</button>
                        <button class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700">Permissions</button>
                        <button class="py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700">Executions</button>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="relative">
                            <input type="text" placeholder="Search" class="pl-10 pr-4 py-2 border rounded-lg w-64"/>
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                    </div>
                     <div class="mt-4 bg-white rounded-lg shadow-md p-8 text-center">
                        <p class="text-gray-500">Where are your Workflows?</p>
                        <p class="text-gray-400 text-sm mt-2">Create your first Workflow with your team to get started.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- Mobile Quick Actions Floating Button -->
    <NexaCRM.WebClient.Components.UI.FloatingActionButton 
        ShowCallAction="true" 
        ShowEmailAction="true" 
        ShowMeetingAction="true" 
        ShowAddAction="true"
        OnActionClicked="HandleFloatingAction" />
</div>

@code {
    private bool showMobileSearch = false;
    private bool showMobileNotifications = false;
    private string mobileSearchQuery = "";

    private async Task NavigateToPage(string url)
    {
        // Close any open mobile panels first
        await CloseMobilePanels();
        
        // Add visual feedback before navigation
        await Task.Delay(150);
        NavigationManager.NavigateTo(url);
    }

    private async Task ScrollToSection(string sectionId)
    {
        // Close any open mobile panels first
        await CloseMobilePanels();
        
        // Use JavaScript to smooth scroll to section
        await JSRuntime.InvokeVoidAsync("eval", $@"
            const element = document.getElementById('{sectionId}');
            if (element) {{
                element.scrollIntoView({{ behavior: 'smooth', block: 'start' }});
            }}
        ");
    }

    private async Task ToggleMobileMenu()
    {
        // Close other mobile panels first
        showMobileSearch = false;
        showMobileNotifications = false;
        StateHasChanged();
        
        // Toggle the main navigation menu - with error handling
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (window.navigationHelper && window.navigationHelper.toggleMenu) {
                    window.navigationHelper.toggleMenu(false);
                }
            ");
        }
        catch (Exception ex)
        {
            // Log error but don't break functionality
            Console.WriteLine($"Navigation helper error: {ex.Message}");
        }
    }

    private async Task ToggleMobileSearch()
    {
        showMobileSearch = !showMobileSearch;
        
        // Close notifications if search is opening
        if (showMobileSearch)
        {
            showMobileNotifications = false;
        }
        
        StateHasChanged();
        
        // Focus on search input if opening - with error handling
        if (showMobileSearch)
        {
            await Task.Delay(100); // Wait for animation
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", @"
                    try {
                        const searchInput = document.querySelector('.mobile-search-input input');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    } catch (e) {
                        console.warn('Search input focus failed:', e);
                    }
                ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Search input focus error: {ex.Message}");
            }
        }
    }

    private async Task ToggleMobileNotifications()
    {
        showMobileNotifications = !showMobileNotifications;
        
        // Close search if notifications is opening
        if (showMobileNotifications)
        {
            showMobileSearch = false;
        }
        
        StateHasChanged();
        await Task.Delay(50); // Small delay for smooth animation
    }

    private async Task CloseMobilePanels()
    {
        if (showMobileSearch || showMobileNotifications)
        {
            showMobileSearch = false;
            showMobileNotifications = false;
            StateHasChanged();
            await Task.Delay(50);
        }
    }

    private async Task HandleMobileSearch(KeyboardEventArgs e)
    {
        // Handle search on Enter key
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(mobileSearchQuery))
        {
            await PerformMobileSearch();
        }
    }

    private async Task PerformMobileSearch()
    {
        // Close search panel
        showMobileSearch = false;
        StateHasChanged();
        
        // Perform search navigation
        var searchUrl = $"/search?q={Uri.EscapeDataString(mobileSearchQuery)}";
        NavigationManager.NavigateTo(searchUrl);
        
        // Clear search query
        mobileSearchQuery = "";
        
        // Add a small delay to ensure state changes are processed
        await Task.Delay(10);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize mobile dashboard navigation after render - with error handling
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", @"
                    try {
                        if (window.navigationHelper && window.navigationHelper.setupMobileDashboardNavigation) {
                            window.navigationHelper.setupMobileDashboardNavigation();
                        }
                    } catch (e) {
                        console.warn('Navigation helper setup failed:', e);
                    }
                ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Navigation helper setup error: {ex.Message}");
            }
            
            // Setup mobile dashboard specific functionality - with error handling
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", @"
                    try {
                        // Force mobile header to be visible
                        const mobileHeader = document.querySelector('.mobile-header');
                        if (mobileHeader && window.innerWidth < 768) {
                            mobileHeader.style.display = 'flex';
                            mobileHeader.style.visibility = 'visible';
                            mobileHeader.style.opacity = '1';
                            mobileHeader.style.position = 'fixed';
                            mobileHeader.style.top = '0';
                            mobileHeader.style.left = '0';
                            mobileHeader.style.right = '0';
                            mobileHeader.style.zIndex = '999999';
                            mobileHeader.style.backgroundColor = '#ffffff';
                            mobileHeader.style.height = '60px';
                            mobileHeader.style.width = '100vw';
                            mobileHeader.style.borderBottom = '1px solid #e5e7eb';
                            mobileHeader.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                            
                            // Ensure all child elements are visible
                            const headerContent = mobileHeader.querySelector('.mobile-header-content');
                            if (headerContent) {
                                headerContent.style.display = 'flex';
                                headerContent.style.width = '100%';
                                headerContent.style.alignItems = 'center';
                                headerContent.style.justifyContent = 'space-between';
                                headerContent.style.padding = '0 16px';
                            }
                            
                            const mobileTitle = mobileHeader.querySelector('.mobile-title');
                            if (mobileTitle) {
                                mobileTitle.style.display = 'block';
                                mobileTitle.style.color = '#000000';
                                mobileTitle.style.fontSize = '20px';
                                mobileTitle.style.fontWeight = '700';
                            }
                            
                            // Check for dark mode and adjust colors
                            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                            if (isDarkMode) {
                                mobileHeader.style.backgroundColor = '#1f2937';
                                mobileHeader.style.borderBottomColor = '#374151';
                                if (mobileTitle) {
                                    mobileTitle.style.color = '#ffffff';
                                }
                                const buttons = mobileHeader.querySelectorAll('button');
                                buttons.forEach(btn => {
                                    btn.style.color = '#ffffff';
                                });
                            }
                        }
                        
                        // Fix dark mode button text colors
                        const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                        if (isDarkMode) {
                            if (window.innerWidth < 768) {
                                const dashboardCards = document.querySelectorAll('.dashboard-card');
                                dashboardCards.forEach(card => {
                                    card.style.backgroundColor = '#374151';
                                    card.style.borderColor = '#4b5563';
                                    card.style.color = '#ffffff';
                                    
                                    const textElements = card.querySelectorAll('h2, span, .text-\\[#0e131b\\]');
                                    textElements.forEach(el => {
                                        el.style.color = '#ffffff';
                                    });
                                });
                            }
                            
                            // Fix priority button text colors in dark mode
                            const priorityButtons = document.querySelectorAll('.priority-button');
                            priorityButtons.forEach(button => {
                                button.style.backgroundColor = '#374151';
                                button.style.color = '#ffffff';
                                button.style.borderColor = '#4b5563';
                                
                                const span = button.querySelector('span');
                                if (span) {
                                    span.style.color = '#ffffff';
                                }
                            });
                            
                            // Fix sidebar navigation links in dark mode
                            const sidebarLinks = document.querySelectorAll('.dashboard-sidebar a');
                            sidebarLinks.forEach(link => {
                                link.style.color = '#ffffff !important';
                                link.style.setProperty('color', '#ffffff', 'important');
                                
                                const allElements = link.querySelectorAll('*');
                                allElements.forEach(el => {
                                    el.style.color = '#ffffff !important';
                                    el.style.setProperty('color', '#ffffff', 'important');
                                });
                                
                                const textElements = link.querySelectorAll('p, div[data-icon], svg');
                                textElements.forEach(el => {
                                    el.style.color = '#ffffff !important';
                                    el.style.setProperty('color', '#ffffff', 'important');
                                    if (el.tagName === 'SVG') {
                                        el.style.fill = '#ffffff !important';
                                        el.style.setProperty('fill', '#ffffff', 'important');
                                    }
                                });
                            });
                            
                            // Fix sidebar background in dark mode
                            const sidebar = document.querySelector('.dashboard-sidebar');
                            if (sidebar) {
                                sidebar.style.backgroundColor = '#1f2937';
                                
                                // Apply to all nested elements
                                const allSidebarElements = sidebar.querySelectorAll('*');
                                allSidebarElements.forEach(el => {
                                    if (el.tagName === 'A' || el.tagName === 'P' || el.tagName === 'DIV') {
                                        el.style.color = '#ffffff !important';
                                        el.style.setProperty('color', '#ffffff', 'important');
                                    }
                                    if (el.tagName === 'SVG') {
                                        el.style.fill = '#ffffff !important';
                                        el.style.setProperty('fill', '#ffffff', 'important');
                                    }
                                });
                            }
                        }
                        // Handle mobile panel backdrop clicks
                        document.addEventListener('click', (e) => {
                            try {
                                if (e.target && e.target.classList) {
                                    if (e.target.classList.contains('mobile-search-bar') && e.target.classList.contains('expanded')) {
                                        // Click on backdrop should close search
                                        const closeBtn = document.querySelector('.mobile-search-close');
                                        if (closeBtn) closeBtn.click();
                                    }
                                    if (e.target.classList.contains('mobile-notifications-panel') && e.target.classList.contains('expanded')) {
                                        // Click on backdrop should close notifications
                                        const closeBtn = document.querySelector('.mobile-notifications-close');
                                        if (closeBtn) closeBtn.click();
                                    }
                                }
                            } catch (clickError) {
                                console.warn('Click handler error:', clickError);
                            }
                        });
                        
                        // Setup swipe gestures for mobile panels
                        let touchStartY = 0;
                        document.addEventListener('touchstart', (e) => {
                            try {
                                if (e.touches && e.touches[0]) {
                                    touchStartY = e.touches[0].clientY;
                                }
                            } catch (touchError) {
                                console.warn('Touch start error:', touchError);
                            }
                        }, { passive: true });
                        
                        document.addEventListener('touchend', (e) => {
                            try {
                                if (e.changedTouches && e.changedTouches[0]) {
                                    const touchEndY = e.changedTouches[0].clientY;
                                    const diff = touchStartY - touchEndY;
                                    
                                    // Swipe up to close panels
                                    if (diff > 50) {
                                        const expandedPanels = document.querySelectorAll('.mobile-search-bar.expanded, .mobile-notifications-panel.expanded');
                                        if (expandedPanels) {
                                            expandedPanels.forEach(panel => {
                                                const closeBtn = panel.querySelector('.mobile-search-close, .mobile-notifications-close');
                                                if (closeBtn) closeBtn.click();
                                            });
                                        }
                                    }
                                }
                            } catch (touchError) {
                                console.warn('Touch end error:', touchError);
                            }
                        }, { passive: true });
                    } catch (setupError) {
                        console.warn('Mobile dashboard setup failed:', setupError);
                    }
                ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Mobile dashboard setup error: {ex.Message}");
            }
        }
    }

    private async Task HandleFloatingAction(string action)
    {
        switch (action)
        {
            case "call":
                // Navigate to contacts page to select a contact to call
                NavigationManager.NavigateTo("/contacts");
                break;
            case "email":
                // Navigate to contacts page to select a contact to email
                NavigationManager.NavigateTo("/contacts");
                break;
            case "meeting":
                // Navigate to calendar/meeting scheduling
                NavigationManager.NavigateTo("/sales-calendar");
                break;
            case "add":
                // Navigate to add new contact/lead page
                NavigationManager.NavigateTo("/contacts");
                break;
        }
        
        // Add a small delay to ensure navigation is processed
        await Task.Delay(10);
    }
}
